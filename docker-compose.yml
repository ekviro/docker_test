version: '3.8'

services:
  # Сервис базы данных PostgreSQL
  postgres:
    image: postgres:15                    # Официальный образ PostgreSQL
    container_name: my-postgres-db        # Имя контейнера для удобства
    environment:
      POSTGRES_DB: mydatabase             # Создаем базу данных при запуске
      POSTGRES_USER: myuser               # Создаем пользователя БД
      POSTGRES_PASSWORD: mypassword       # Устанавливаем пароль
    ports:
      - "5432:5432"                       # Пробрасываем порт БД на локальную машину
    volumes:
      - postgres_data:/var/lib/postgresql/data      # Постоянное хранилище данных БД
      - ./init-scripts:/docker-entrypoint-initdb.d  # Скрипты инициализации БД
    restart: unless-stopped               # Автоперезапуск при падении

  # Сервис FastAPI сервера
  server:
    build:
      context: .                          # Контекст сборки - корневая папка
      dockerfile: server/Dockerfile       # Путь к Dockerfile сервера
    container_name: my-fastapi-server     # Имя контейнера сервера
    ports:
      - "8000:8000"                       # Пробрасываем порт API на локальную машину
    depends_on:
      - postgres                          # Запускать после запуска БД
    environment:
      - DB_HOST=postgres                  # Для Docker: подключаться к БД по имени сервиса
    restart: unless-stopped               # Автоперезапуск при падении

  # Сервис для запуска тестов
  tests:
    build:
      context: .                          # Контекст сборки - корневая папка
      dockerfile: tests/Dockerfile        # Путь к Dockerfile тестов
    container_name: my-tests              # Имя контейнера тестов
    depends_on:
      - server                            # Запускать после запуска сервера
    environment:
      - API_URL=http://server:8000        # Для Docker: обращаться к серверу по имени сервиса
    restart: "no"                         # Не перезапускать после завершения

# Определяем тома для хранения данных
volumes:
  postgres_data:                          # Том для постоянного хранения данных БД